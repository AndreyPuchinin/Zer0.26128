на каждом шаге замены А на В создаем объект структуры с полями:

предыдущая строка
текущая строка
значение ссылки (замены)
имя ссылки (замены)
позиция замены
карта:

-имя
-обычные значения
-самоссылки
-шаблоны
--...
-шаблоны и самоссылки
+идентификаторы!