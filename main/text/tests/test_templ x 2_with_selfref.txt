+ - тесты на >1 шаблона в 1 строку (с одной самоссылкой):

    КАРТЫ С ОБЫЧНЫМИ ЗНАЧЕНИЯМИ:
    число: 3

    КАРТЫ С ШАБЛОННЫМИ ЗНАЧЕНИЯМИ:
    дважды число: число+число
    число квадрат: число*число

    КАРТЫ СО ЗНАЧЕНИЯМИ-САМОССЫЛКАМИ:
    число: (дважды число)

    СТРОКА
    (3+3)*(3+3)

    ПРЯМЫЕ ЗАМЕНЫ:

    -ОБЫЧНЫЕ ПРЯМЫЕ ЗАМЕНЫ:
    ...
    (число+число)*(число+число)

    -ПРЯМЫЕ ЗАМЕНЫ ПО САМОССЫЛКАМ
    -отсутствуют

    -ПРЯМЫЕ ШАБЛОННЫЕ ЗАМЕНЫ
    (дважды число)*(число+число)
    (дважды число)*(дважды число)

    -ПРОВЕРКА НА ТО, ЧТО В ПОСЛЕДНЮЮ ВЕРСИЮ СТРОКИ ВСЕ ЕЩЕ ЧТО-ТО ВХОДИТ ИЗ ЗНАЧЕНИЙ ХОТЯ БЫ КАКОГО-ТО ТИПА
    -есть, продолжаем

    -ОБЫЧНЫЕ ПРЯМЫЕ ЗАМЕНЫ:
    -отсутствуют

    -ПРЯМЫЕ ЗАМЕНЫ ПО САМОССЫЛКАМ
    число*(дважды число)
    число*число

    -ПРЯМЫЕ ШАБЛОННЫЕ ЗАМЕНЫ
    число квадрат

    -ПРОВЕРКА НА ТО, ЧТО В ПОСЛЕДНЮЮ ВЕРСИЮ СТРОКИ ВСЕ ЕЩЕ ЧТО-ТО ВХОДИТ ИЗ ЗНАЧЕНИЙ ХОТЯ БЫ КАКОГО-ТО ТИПА
    -нет, переходим к обратным заменам

    ОБРАТНЫЕ ЗАМЕНЫ:
    (дважды число) квадрат
    (дважды 3) квадрат

    ИТОГ:
    (дважды 3) квадрат

    ПРИ ЭТОМ ВАЖНО УЧЕСТЬ И ЗАТКНУТЬ ВСЕ ДЫРКИ, ОТКУДА МОЖЕТ ПОТЕЧЬ КОЛЛИЗИЯ,
    а это,
    например,
    -когда коллизия в первом шаблоне,
    -когда коллизия во втором шаблоне,
    -когда коллизия в некоторых шаблонах,
    -когда коллизии во всех шаблонах.

    (При этом данные случаи могут быть покрыты не обязательно тем же числом тестов - может, >, может, <)

    Возможно, имеет смысл попытаться сформулировать тот же тест также без самоссылок
    (чтобы не усложнять, хотя, возможно, это лишь на пользу)